# 深入浅出CUDA线程模型索引

## 线程模型
以一维线程模型为例，假设一共32个threads，根据不同的block大小，线程索引如下

<img src="https://raw.githubusercontent.com/Daydream0929/daydream0929.github.io/master/_screenshots/2024-02-24_1.png" width="50%" height=auto class="center"/>

## 高维坐标--->一维坐标
假设有一个三维坐标(x, y, z)，各个维度的大小分别为Dx, Dy, Dz。则一维坐标表示为
* id = z * Dx * Dy + y * Dx + x
理解了高维坐标向一维坐标的转化，结合理解CUDA线程模型，那么CUDA线程模型的索引就很容易理解了。

```
#include "error.cuh"

__global__ void test()
{
    const int bx = blockIdx.x;
    const int by = blockIdx.y;
    const int tx = threadIdx.x;
    const int ty = threadIdx.y;
    const int tz = threadIdx.z;
    const int bid = by * blockDim.x + bx; // // 整个grid内部的block_idx
    const int block_tid = tz * (blockDim.x * blockDim.y) + ty * blockDim.x + tx;    // 每个block内部的thread_idx
    const int global_tid = bid * (blockDim.x * blockDim.y * blockDim.z) + block_tid;    // 整个grid内部的thread_idx
    printf("bid: %d  --- block_tid : %d  --- globa_tid : %d\n", bid, block_tid, global_tid);
}

int main()
{
    dim3 blocks_per_grid = {2, 2, 1};
    dim3 threads_per_block = {2, 3, 4};
    test<<<blocks_per_grid, threads_per_block>>>();
    cudaDeviceSynchronize();
    return 0;
}
```

